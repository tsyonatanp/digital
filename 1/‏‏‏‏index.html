<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מסך לובי דיגיטלי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Rubik', sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e5f4ff 100%);
            font-size: 1.8rem;
            overscroll-behavior: none;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 30% 30% 40%;
            gap: 0.75rem;
            flex: 1;
            min-height: 0;
        }
        .main-grid > div {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .section-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 1rem;
            height: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .section-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .section-box h2 {
            font-size: 2.2rem;
            color: #b91c1c;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            padding-bottom: 0.5rem;
        }
        .section-box h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #b91c1c, transparent);
            border-radius: 2px;
        }
        #clock {
            color: #1e3a8a;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .date-clock-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem 1.5rem;
            box-sizing: border-box;
            text-align: center;
            transition: transform 0.3s ease;
            width: fit-content;
        }
        .date-clock-container:hover {
            transform: scale(1.02);
        }
        .date-clock-container .welcome {
            font-size: 2.8rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.3rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1.1;
        }
        .date-clock-container .clock {
            font-size: 3rem;
            font-weight: 700;
            color: #1e40af;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1;
            margin-top: 0.3rem;
        }
        .date-clock-container .date {
            font-size: 2rem;
            font-weight: 500;
            color: #1f2937;
            margin: 0.3rem 0;
            line-height: 1;
        }
        @keyframes scroll {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-50%);
            }
        }
        .auto-scroll {
            animation: scroll 60s linear infinite;
        }
        .auto-scroll:hover {
            animation-play-state: paused;
        }
        .news-section {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.5);
            transition: background-color 0.3s ease;
        }
        .news-section:hover {
            background: rgba(255, 255, 255, 0.8);
        }
        .news-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        .news-item:hover {
            transform: translateX(-5px);
            background: rgba(255, 255, 255, 0.9);
        }
        .news-item span.text-3xl {
            font-weight: 500;
            line-height: 1.4;
        }
        .bottom-section {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        .weather-container {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .credits {
            height: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
            flex-direction: row-reverse;
        }
        #music-toggle {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8) 0%, rgba(37, 99, 235, 0.8) 100%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
            backdrop-filter: blur(5px);
        }
        #music-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
        }
        .ad-slot {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .ad-slot:hover {
            transform: scale(1.02);
        }
        .ad-slot img {
            transition: transform 0.3s ease;
        }
        .ad-slot:hover img {
            transform: scale(1.05);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }
    </style>
</head>

<body class="relative z-10 text-gray-900">
    <audio id="background-music" loop preload="auto">
        <source src="1.mp4" type="audio/mp4">
    </audio>

    <button id="music-toggle" class="fixed bottom-4 right-4 z-50 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
    </button>

    <button id="refresh-ads-btn" class="fixed bottom-4 left-4 z-50 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors" title="רענון קשיח של הדף">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582M20 20v-5h-.581M5.582 9A7.978 7.978 0 014 12c0 4.418 3.582 8 8 8a7.978 7.978 0 006.418-3M15 11h5V6m-1.418 5A7.978 7.978 0 0020 12c0-4.418-3.582-8-8-8a7.978 7.978 0 00-6.418 3" />
        </svg>
    </button>

    <div class="main-content">
        <div class="main-grid">
            <div class="h-full flex flex-col">
                <div class="section-box h-fit mb-2 flex flex-col items-center">
                    <div class="date-clock-container">
                        <div class="welcome">ברוכים הבאים חרמון 3</div>
                        <div class="date">
                            <span id="hebrew-date">טוען תאריך עברי...</span>
                            <span> | </span>
                            <span id="gregorian-date">טוען תאריך לועזי...</span>
                        </div>
                        <div id="clock" class="clock">--:--</div>
                    </div>
                </div>
                <div class="section-box h-full flex flex-col items-center justify-start gap-2 pb-6">
                    <h2 class="font-bold text-red-600">הודעות לדיירים</h2>
                    <div class="overflow-hidden h-full w-full">
                        <div class="auto-scroll">
                            <ul class="text-2xl space-y-1 pr-2" id="resident-announcements">
                                <li>טוען הודעות...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-full">
                <div class="section-box h-full flex flex-col justify-start">
                    <div class="news-section">
                        <h2 class="font-bold mb-2">ynet - חדשות חמות</h2>
                        <ul class="text-4xl space-y-1" id="ynet-news">
                            <li>טוען חדשות...</li>
                        </ul>
                    </div>
                    <div class="news-section">
                        <h2 class="font-bold mb-2 text-blue-600" id="one-title">ONE - עדכוני ספורט</h2>
                        <ul class="text-4xl space-y-1" id="one-news">
                            <li>טוען ONE...</li>
                        </ul>
                    </div>
                    <div class="news-section">
                        <h2 class="font-bold mb-2 text-blue-600">גלובס - כלכלה ומסחר</h2>
                        <ul class="text-4xl space-y-1" id="globes-news">
                            <li>טוען גלובס...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="h-full flex flex-col">
                <div class="grid grid-rows-2 gap-2 flex-1">
                    <div class="section-box h-full flex flex-col justify-center items-center" id="ad-slot-1">
                        <span>טוען פרסום...</span>
                    </div>
                    <div class="section-box h-full flex flex-col justify-center items-center" id="ad-slot-2">
                        <span>טוען פרסום...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="weather-container">
                <div id="ww_168a241545936" v='1.3' loc='id' a='{"t":"responsive","lang":"he","sl_lpl":1,"ids":["wl9138"],"font":"Arial","sl_ics":"one_a","sl_sot":"celsius","cl_bkg":"image","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA","cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722","cl_odd":"#0000000a","el_nme":3}'>
                    <a href="https://weatherwidget.org/" id="ww_168a241545936_u" target="_blank">weatherwidget.org</a>
                </div>
                <script async src="https://app3.weatherwidget.org/js/?id=ww_168a241545936"></script>
            </div>
            <div class="credits" style="display: flex; align-items: center;">
                <span style="flex:1; font-weight: bold; white-space: nowrap; text-align: right; font-size: 1.5em; color: #2563eb;">להזמנת המערכת התקשרו ל־054-7274527</span>
                <span style="flex:2; text-align: center;">שלג דיגיטל | ניגוני הינוקא | ynet חדשות | ONE / גלובס | תחזית מזג האוויר לפי wttr.in</span>
                <span style="flex:1"></span>
            </div>
        </div>
    </div>

    <script>
        // הפעלת מוזיקת רקע (ידנית בלבד)
        document.addEventListener('DOMContentLoaded', function() {
            const backgroundMusic = document.getElementById('background-music');
            const musicToggle = document.getElementById('music-toggle');
            let isMusicPlaying = false;

            backgroundMusic.volume = 0.5;

            musicToggle.addEventListener('click', function() {
                if (isMusicPlaying) {
                    backgroundMusic.pause();
                    musicToggle.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                    `;
                } else {
                    backgroundMusic.play().catch(error => {
                        console.error('שגיאה בניגון המוזיקה:', error);
                    });
                    musicToggle.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                    `;
                }
                isMusicPlaying = !isMusicPlaying;
            });
        });

        // תאריך עברי עם מטמון
        function getHebrewDate(gregorianDate) {
            const today = gregorianDate.toDateString();
            const cachedDate = localStorage.getItem('hebrewDate');
            const cachedDay = localStorage.getItem('hebrewDateDay');
            if (cachedDate && cachedDay === today) {
                return Promise.resolve(cachedDate);
            }
            return fetch(`https://www.hebcal.com/converter?cfg=json&gy=${gregorianDate.getFullYear()}&gm=${gregorianDate.getMonth() + 1}&gd=${gregorianDate.getDate()}&g2h=1`)
                .then(response => response.json())
                .then(data => {
                    const fullHebrew = data.hebrew.replace(/ תש.*/, '');
                    localStorage.setItem('hebrewDate', fullHebrew);
                    localStorage.setItem('hebrewDateDay', today);
                    return fullHebrew;
                })
                .catch(error => {
                    console.error('Failed to fetch Hebrew date:', error);
                    return 'תאריך עברי לא זמין';
                });
        }

        function updateClock() {
            const now = new Date();
            const gregorianDate = now.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById("gregorian-date").textContent = gregorianDate;
            
            getHebrewDate(now).then(hebrewDate => {
                document.getElementById("hebrew-date").textContent = hebrewDate;
            });

            const timeStr = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById("clock").textContent = timeStr;
        }

        setInterval(updateClock, 1000);
        updateClock();

        // מערכי חדשות ואינדקסים לסבב
        let ynetNewsItems = [];
        let oneNewsItems = [];
        let globesNewsItems = [];
        let ynetIndex = 0;
        let oneIndex = 0;
        let globesIndex = 0;

        function displayNewsItems(containerId, items, index, bulletColor) {
            const list = document.getElementById(containerId);
            list.innerHTML = "";
            const start = index % items.length;
            const item = items[start];
            const li = document.createElement("li");
            li.className = "news-item";
            li.innerHTML = `
                <span class="font-bold text-${bulletColor}-600 text-xl align-middle">•</span>
                <span class="text-3xl">${item.title}</span>
            `;
            list.appendChild(li);
        }

        function rotateNews() {
            if (ynetNewsItems.length > 0) {
                displayNewsItems("ynet-news", ynetNewsItems, ynetIndex, "red");
                ynetIndex = (ynetIndex + 1) % ynetNewsItems.length;
            }
            if (oneNewsItems.length > 0) {
                displayNewsItems("one-news", oneNewsItems, oneIndex, "blue");
                oneIndex = (oneIndex + 1) % oneNewsItems.length;
            }
            if (globesNewsItems.length > 0) {
                displayNewsItems("globes-news", globesNewsItems, globesIndex, "blue");
                globesIndex = (globesIndex + 1) % globesNewsItems.length;
            }
        }

        function fetchYnetNews() {
            const cachedNews = localStorage.getItem('ynetNews');
            if (cachedNews) {
                ynetNewsItems = JSON.parse(cachedNews);
                ynetIndex = 0;
                displayNewsItems("ynet-news", ynetNewsItems, ynetIndex, "red");
                ynetIndex = (ynetIndex + 1) % ynetNewsItems.length;
            }
            fetch("https://api.rss2json.com/v1/api.json?rss_url=https://www.ynet.co.il/Integration/StoryRss1854.xml")
                .then(res => res.json())
                .then(data => {
                    ynetNewsItems = data.items.slice(0, 10);
                    localStorage.setItem('ynetNews', JSON.stringify(ynetNewsItems));
                    ynetIndex = 0;
                    displayNewsItems("ynet-news", ynetNewsItems, ynetIndex, "red");
                    ynetIndex = (ynetIndex + 1) % ynetNewsItems.length;
                })
                .catch(error => console.error('Failed to fetch Ynet news:', error));
        }

        function loadResidentAnnouncements() {
            const residentList = document.getElementById('resident-announcements');
            
            // בדיקה אם יש הודעות במטמון ואם הן עדיין תקפות (פחות מ-5 דקות)
            const cachedData = localStorage.getItem('residentAnnouncements');
            const cacheTime = localStorage.getItem('residentAnnouncementsTime');
            const now = Date.now();
            
            if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 5 * 60 * 1000) {
                displayAnnouncements(JSON.parse(cachedData));
                return;
            }

            // אם אין מטמון תקף, טען מהשרת
            fetch('save_message.php?read=1')
                .then(response => response.text())
                .then(text => {
                    const lines = text.trim().split("\n").filter(line => line.trim() !== "");
                    
                    // שמירה במטמון
                    localStorage.setItem('residentAnnouncements', JSON.stringify(lines));
                    localStorage.setItem('residentAnnouncementsTime', now.toString());
                    
                    displayAnnouncements(lines);
                })
                .catch(error => {
                    console.error('Failed to load resident announcements:', error);
                    residentList.innerHTML = '<li><span class="text-2xl">שגיאה בטעינת ההודעות</span></li>';
                });
        }

        function displayAnnouncements(lines) {
            const residentList = document.getElementById('resident-announcements');
            residentList.innerHTML = "";
            
            if (!lines || lines.length === 0) {
                residentList.innerHTML = '<li><span class="text-2xl">אין הודעות חדשות</span></li>';
                return;
            }

            const announcements = lines.map(line => 
                `<li><span class="font-bold text-red-600 text-xl align-middle">•</span> <span class="text-3xl">${line}</span></li>`
            ).join('');
            
            residentList.innerHTML = announcements;
        }

        function showAdSlider(slotId, ads, interval = 30000) {
            let idx = 0;
            const slot = document.getElementById(slotId);

            async function show() {
                if (!ads.length) {
                    slot.innerHTML = '<span>אין פרסומים</span>';
                    return;
                }
                // Preload next image
                const img = new Image();
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.alt = 'פרסום';
                img.onerror = function() {
                    slot.innerHTML = '<span>שגיאה בטעינת תמונה</span>';
                };
                img.onload = function() {
                    slot.innerHTML = '';
                    slot.appendChild(img);
                };
                img.src = ads[idx] + '?v=' + Date.now(); // cache busting
            }

            show();
            if (ads.length > 1) {
                setInterval(() => {
                    idx = (idx + 1) % ads.length;
                    show();
                }, interval);
            }
        }

        function loadAds() {
            fetch('save_message.php?ads_top=1')
                .then(res => res.json())
                .then(ads => showAdSlider('ad-slot-1', ads))
                .catch(() => showAdSlider('ad-slot-1', []));
            fetch('save_message.php?ads_bottom=1')
                .then(res => res.json())
                .then(ads => showAdSlider('ad-slot-2', ads))
                .catch(() => showAdSlider('ad-slot-2', []));
        }

        async function fetchOneAndGlobesNews() {
            try {
                const cachedOneNews = localStorage.getItem('oneNews');
                if (cachedOneNews) {
                    oneNewsItems = JSON.parse(cachedOneNews);
                    oneIndex = 0;
                    displayNewsItems("one-news", oneNewsItems, oneIndex, "blue");
                    oneIndex = (oneIndex + 1) % oneNewsItems.length;
                }
                const cachedGlobesNews = localStorage.getItem('globesNews');
                if (cachedGlobesNews) {
                    globesNewsItems = JSON.parse(cachedGlobesNews);
                    globesIndex = 0;
                    displayNewsItems("globes-news", globesNewsItems, globesIndex, "blue");
                    globesIndex = (globesIndex + 1) % globesNewsItems.length;
                }

                const oneResponse = await fetch("https://api.rss2json.com/v1/api.json?rss_url=https://www.one.co.il/rss/");
                const oneData = await oneResponse.json();
                oneNewsItems = oneData.items.slice(0, 10);
                localStorage.setItem('oneNews', JSON.stringify(oneNewsItems));

                const globesResponse = await fetch("https://api.rss2json.com/v1/api.json?rss_url=https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=585");
                const globesData = await globesResponse.json();
                globesNewsItems = globesData.items.slice(0, 10);
                localStorage.setItem('globesNews', JSON.stringify(globesNewsItems));

                oneIndex = 0;
                globesIndex = 0;
                displayNewsItems("one-news", oneNewsItems, oneIndex, "blue");
                oneIndex = (oneIndex + 1) % oneNewsItems.length;
                displayNewsItems("globes-news", globesNewsItems, globesIndex, "blue");
                globesIndex = (globesIndex + 1) % globesNewsItems.length;
            } catch (error) {
                console.error('Failed to fetch ONE or Globes news:', error);
            }
        }

        fetchYnetNews();
        fetchOneAndGlobesNews();
        loadResidentAnnouncements();
        loadAds();

        setInterval(rotateNews, 10000);
        setInterval(fetchYnetNews, 30 * 60000);
        setInterval(fetchOneAndGlobesNews, 30 * 60000);
        setInterval(loadResidentAnnouncements, 30 * 60000);
        setInterval(loadAds, 1800000);

        document.getElementById('refresh-ads-btn').addEventListener('click', function() {
            location.reload(); // רענון קשיח של הדף
        });
    </script>
</body>
</html>